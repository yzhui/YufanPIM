<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans 
						http://www.springframework.org/schema/beans/spring-beans.xsd
					    http://www.springframework.org/schema/security
					    http://www.springframework.org/schema/security/spring-security.xsd">

	<security:http entry-point-ref="casEntryPoint" auto-config="false">
		<security:custom-filter position="CAS_FILTER"
			ref="casAuthenticationFilter" />
		<!-- SingleSignOutFilter放在CAS_FILTER之前 -->
		<security:custom-filter ref="casLogoutFilter"
			position="LOGOUT_FILTER" />
		<security:custom-filter after="EXCEPTION_TRANSLATION_FILTER" 
			ref="exceptionFilter"/>
			
		<security:custom-filter ref="requestCasLogoutFilter"
			before="LOGOUT_FILTER" />
		<security:custom-filter ref="resourceSecurityInterceptor" 
			before="FILTER_SECURITY_INTERCEPTOR" />
		<security:intercept-url pattern="/index**"
			access="permitAll" />
		<security:intercept-url pattern="/resources/**"
			access="permitAll" />
		<security:intercept-url pattern="/upload/**"
			access="permitAll" />
		<security:intercept-url pattern="*.js"
			access="permitAll" />
		<security:intercept-url pattern="*.css"
			access="permitAll" />
		<security:intercept-url pattern="*.jpg"
			access="permitAll" />
		<security:intercept-url pattern="*.png"
			access="permitAll" />
		<security:intercept-url pattern="*.gif"
			access="permitAll" />
        <security:intercept-url pattern="/**" access="!anonymous"/>
		<security:form-login login-page="http://auth.yudorm.com:8082/cas/login"
			username-parameter="username" password-parameter="password"
			default-target-url="http://localhost:8080/mall/mobile/index.htm" />
		<security:remember-me remember-me-parameter="remember_me" user-service-ref="userDetailsService"/>
		<security:csrf disabled="true" />
		<security:headers>
			<security:frame-options disabled="true" />
		</security:headers>
	</security:http>

	<bean id="resourceSecurityInterceptor"
		class="org.springframework.security.web.access.intercept.FilterSecurityInterceptor">
		<property name="authenticationManager"
			ref="authenticationManager" />
		<property name="accessDecisionManager"
			ref="accessDecisionManager" />
		<property name="securityMetadataSource"
			ref="secureResourceFilterInvocationDefinitionSource" />
		<property name="observeOncePerRequest" value="false" />
	</bean>
	
	<bean id="secureResourceFilterInvocationDefinitionSource"
		class="com.sailmi.mall.core.security.interceptor.SecureResourceFilterInvocationDefinitionSource" />
	
	<bean id="accessDecisionManager"
		class="org.springframework.security.access.vote.AffirmativeBased">
		<constructor-arg>
			<list>
				<bean
					class="org.springframework.security.access.vote.RoleVoter" />
				<bean
					class="org.springframework.security.access.vote.AuthenticatedVoter" />
			</list>
			</constructor-arg>
		<property name="allowIfAllAbstainDecisions" value="false" />
	</bean>

	<bean id="requestCasLogoutFilter"
		class="org.springframework.security.web.authentication.logout.LogoutFilter">
		<!-- 指定登出成功后需要跳转的地址，这里指向Cas Server的登出URL，以实现单点登出 -->
		<constructor-arg value="http://auth.yudorm.com:8082/cas/logout" />
		<constructor-arg>
			<bean
				class="org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler" />
		</constructor-arg>
		<!-- 该Filter需要处理的地址，默认是Spring Security的默认登出地址“/j_spring_security_logout” -->
		<property name="filterProcessesUrl" value="/j_spring_cas_security_logout" />
	</bean>
	<bean id="casLogoutFilter" class="org.jasig.cas.client.session.SingleSignOutFilter" />

	<!-- 认证的入口 -->
	<bean id="casEntryPoint"
		class="org.springframework.security.cas.web.CasAuthenticationEntryPoint">
		<!-- Cas Server的登录地址，elim是我的计算机名 -->
		<property name="loginUrl" value="http://auth.yudorm.com:8082/cas/login" />
		<!-- service相关的属性 -->
		<property name="serviceProperties" ref="serviceProperties" />
	</bean>
	<bean id="exceptionFilter"
		class="com.sailmi.mall.core.security.support.ShopSecurityExceptionFilter">
		<constructor-arg>
			 <ref bean="casEntryPoint"/>  
		</constructor-arg>
		<property name="AuthenFailUrl_403"	value="http://auth.yudorm.com:8082/cas/login" />
	</bean>
	<bean id="casAuthenticationFilter"
		class="com.sailmi.mall.core.security.TokenOrCasAuthenticationFilter">
		<property name="authenticationManager" ref="authenticationManager" />
		<property name="userDetailService" ref="userDetailsService"  />
		<property name="filterProcessesUrl" value="/j_spring_cas_security_check" />
		
		<property name="authenticationFailureHandler" ref="deniedHandler"/> 
		<!-- 认证成功返回的页面，此处做了修改，这个类是继续之前的操作。默认的类是设置一个固定的页面  -->
		<property name="authenticationSuccessHandler"> 
			<bean class="org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler"/> 
		</property> 
	</bean>

	<bean id="deniedHandler" class="com.sailmi.mall.core.security.support.ShopAccessDeniedHandler"> 
		<constructor-arg value="http://auth.yudorm.com:8082/cas/login" />
	</bean> 

	<bean id="sessionRegistry"
		class="org.springframework.security.core.session.SessionRegistryImpl" />
	<bean id="securityManager"
		class="com.sailmi.mall.core.security.support.SecurityManagerSupport" />

	<security:authentication-manager alias="authenticationManager">
		<security:authentication-provider
			ref="shareAuthenticationProvider" />
	</security:authentication-manager>

	<bean id="shareAuthenticationProvider"
		class="com.sailmi.mall.core.security.ShareAuthenticationProviderDecorator">
		<property name="authenticationProvider" ref="casAuthenticationProvider" />
	</bean>
	<bean id="casAuthenticationProvider"
		class="org.springframework.security.cas.authentication.CasAuthenticationProvider">
		<property name="authenticationUserDetailsService">
			<bean
				class="org.springframework.security.core.userdetails.UserDetailsByNameServiceWrapper">
				<constructor-arg ref="userDetailsService" />
			</bean>
		</property>
		<property name="serviceProperties" ref="serviceProperties" />
		<property name="ticketValidator">
			<bean class="org.jasig.cas.client.validation.Cas20ServiceTicketValidator">
				<constructor-arg index="0"
					value="http://auth.yudorm.com:8082/cas" />
			</bean>
		</property>
		<property name="key" value="key4CasAuthenticationProvider" />
	</bean>
	<bean id="userDetailsService" class="com.sailmi.mall.core.security.DbUserDetailService">
		<property name="dataSource" ref="dataSource"/>
		<property name="enableAuthorities" value="true"/>
		<property name="userInfoUrl"
			value="http://saas.yudorm.com:8080/ydsaas/userController.do?appGetUserByCasUserName" />
		<property name="userTokenUrl" value="http://saas.yudorm.com:8080/ydsaas/userController.do?appGetUserInfo"/>

		<property name="authoritiesByUsernameQuery">
			<value>
                <![CDATA[
                	select smmall_user.userName,smmall_role.roleCode from smmall_role,smmall_user  where 
                	(position(smmall_role.type in smmall_user.userRole)>0) and smmall_user.userName=?
                ]]>
			</value>
		</property>

		<property name="usersByUsernameQuery">
			<value>
                <![CDATA[SELECT id,userName,userCode, password, 1 AS enabled
                           FROM smmall_user
                          WHERE userName = ?]]>
			</value>
		</property>
	</bean>

	<bean id="serviceProperties" class="org.springframework.security.cas.ServiceProperties">
		<!--[login/cas]是Spring Security 4.0后修改的地址、跟3.X版本完全不同、请勿修改 -->
		<property name="service"
			value="http://localhost:8080/mall/j_spring_cas_security_check" />
		<property name="sendRenew" value="false" />
	</bean>
	<bean id="passwordEncoder"
		class="org.springframework.security.authentication.encoding.Md5PasswordEncoder" />

</beans>